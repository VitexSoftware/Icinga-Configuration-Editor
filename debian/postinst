#!/bin/sh
# postinst script for icinga-editor

set -e

IECFG="/usr/share/icinga-editor/includes/Configure.php"


if [ ! -f $IECFG ]; then
    echo '<?php' > $IECFG
fi

#Replace Key Value in PhinX Config File
replaceYML() {
    cfg="/var/lib/icinga-editor/phinx.yml"
    sed -i "/${1}:/c\        ${1}: ${2}" $cfg
}

replacePHP() {
    if [ `cat ${IECFG} | grep "define('${1}'," | wc -l` = "0" ]; then
        echo "define('${1}', '${2}');" >> ${IECFG}
    else
        sed -i "/${1}/c\define('${1}', '${2}');" ${IECFG}
    fi
}



. /usr/share/debconf/confmodule

db_input critical icinga-editor/SEND_MAILS_FROM || true
db_go || true
db_get icinga-editor/SEND_MAILS_FROM
SEND_MAILS_FROM=$RET

db_input critical icinga-editor/ICINGA_SERVER_IP || true
db_go || true
db_get icinga-editor/ICINGA_SERVER_IP
ICINGA_SERVER_IP=$RET


. /usr/share/dbconfig-common/dpkg/postinst.mysql
dbc_dbuser="icinga_editor"
dbc_dbname="icinga_editor"
dbc_generate_include_owner="root:www-data"
dbc_generate_include_perms="0640"
dbc_generate_include=sh:/etc/icinga-editor/config-db.sh

if ! dbc_go icinga-editor $@ ; then
        echo 'Automatic configuration using dbconfig-common failed!'
fi

. /etc/icinga-editor/config-db.sh


IWCFG="/etc/dbconfig-common/icinga-web.conf"
IW_SERVER_USERNAME=`cat $IWCFG | grep dbc_dbuser= | awk -F\' '{print $2}'`
IW_SERVER_PASSWORD=`cat $IWCFG | grep dbc_dbpass= | awk -F\' '{print $2}'`
IW_DATABASE=`cat $IWCFG | grep dbc_dbname= | awk -F\' '{print $2}'`


replacePHP "DB_IW_SERVER_USERNAME" $IW_SERVER_USERNAME
replacePHP "DB_IW_SERVER_PASSWORD" $IW_SERVER_PASSWORD
replacePHP "DB_IW_DATABASE" $IW_DATABASE

if [ "$1" = "configure" ]; then

        db_version 2.0

        mkdir -p /usr/share/icinga-editor/log
        mkdir -p /usr/share/icinga-editor/temp
        mkdir -p /usr/share/icinga/htdocs/images/logos/custom

        chown -R www-data:www-data    /etc/icinga/generated
        chown -R www-data:www-data    /usr/share/icinga-editor/log
        chown -R www-data:www-data    /usr/share/icinga-editor/temp
        chown -R www-data:www-data    /usr/share/icinga/htdocs/images/logos/custom

        if [ -f /etc/init.d/apache2 ] ; then
            a2enconf icinga-editor
            service apache2 reload
        fi

        if [ -f /etc/init.d/avahi ] ; then
            service avahi reload
        fi

fi


cd /usr/share/icinga-editor

if [ -f composer.lock ] ; then
    rm composer.lock
fi

composer --no-dev -o update

    . /etc/icinga-editor/config-db.sh

replacePHP "DB_TYPE" "mysql"
replacePHP "DB_SERVER_HOST" "localhost"
replacePHP "DB_SERVER_USERNAME" $dbuser
replacePHP "DB_SERVER_PASSWORD" $dbpass
replacePHP "DB_DATABASE" $dbname
replacePHP "DB_PREFIX" ""
replacePHP "SEND_MAILS_FROM" $SEND_MAILS_FROM

#replacePHP "LOG_DIRECTORY" "/var/log/"
#replacePHP "CFG_GENERATED" "/etc/icinga/generated/"
#replacePHP "LOG_NAME" "IcingaEditor"
#replacePHP "LOG_TYPE" "syslog"


replaceYML "adapter"    "mysql"
replaceYML "host"       "localhost"
replaceYML "port"       3306
replaceYML "user"       $dbuser
replaceYML "pass"       $dbpass
replaceYML "name"       $dbname

phinx -n -c/var/lib/icinga-editor/phinx.yml migrate -e production


# Import configuration Question ?
db_input medium icinga-editor/IMPORT_CONFIG || true
db_go

# Check their answer.
db_get icinga-editor/IMPORT_CONFIG
if [ "$RET" = "true" ]; then
    iecfgimporter /etc/icinga/icinga.cfg
fi


#DEBHELPER#

exit 0
